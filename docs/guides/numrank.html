<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.523">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>primate - Guide - numerical rank</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": true,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">PRIMATE</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/peekxc/primate"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Guide - numerical rank</li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Basics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../basic/install.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Installation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../basic/integration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Integration</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../imate_compare.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Comparison to <em>imate</em></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Theory</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../theory/intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../theory/matrix_functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Matrix functions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../theory/lanczos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The Lanczos Method</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Advanced</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../advanced/cpp_integration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Usage from C++</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../reference/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">API Reference</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference/diagonalize.lanczos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lanczos</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference/trace.hutch.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hutch</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference/trace.xtrace.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">XTrace</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference/operator.matrix_function.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Matrix Function</span></a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false">
 <span class="menu-text">Random</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference/random.rademacher.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Rademacher</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference/random.normal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Normal</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#computing-the-rank-of-a-matrix" id="toc-computing-the-rank-of-a-matrix" class="nav-link active" data-scroll-target="#computing-the-rank-of-a-matrix">Computing the rank of a matrix</a></li>
  <li><a href="#computing-the-numerical-rank" id="toc-computing-the-numerical-rank" class="nav-link" data-scroll-target="#computing-the-numerical-rank">Computing the numerical rank</a></li>
  <li><a href="#packaging-it-all-up" id="toc-packaging-it-all-up" class="nav-link" data-scroll-target="#packaging-it-all-up">Packaging it all up</a></li>
  <li><a href="#polynomial-trace-approximation" id="toc-polynomial-trace-approximation" class="nav-link" data-scroll-target="#polynomial-trace-approximation">Polynomial trace approximation</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Guide - numerical rank</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div id="cc5035f7" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> primate.trace <span class="im">import</span> xtrace, hutch</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> primate.random <span class="im">import</span> symmetric</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> symmetric(<span class="dv">150</span>)  <span class="co">## random positive-definite matrix </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="computing-the-rank-of-a-matrix" class="level2">
<h2 class="anchored" data-anchor-id="computing-the-rank-of-a-matrix">Computing the rank of a matrix</h2>
<p>In general, the accuracy of the action <span class="math inline">v \mapsto f(A)v</span> as approximated by <code>matrix_function</code> depends both on the parameters of the underlying Lanczos computation and properties of <span class="math inline">f</span> itself. Spectral functions that are either difficult or impossible to approximate via low-degree polynomials, for example, may suffer more from inaccuracy issues. For example, consider the following matrix function equivalence: <span class="math display"> f(\lambda) = \mathrm{sign}(\lambda) \Leftrightarrow \mathrm{tr}(f(A)) = \mathrm{rank}(A)</span></p>
<p>While true in theory, blind-application of the <span class="math inline">\mathrm{sign}</span> function to the spectrum of <span class="math inline">A</span> computationally does not yield a good rank estimator.</p>
<div id="055dc751" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> primate.operator <span class="im">import</span> matrix_function</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">## Make a rank-deficient operator</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>ew <span class="op">=</span> np.sort(np.random.uniform(size<span class="op">=</span>A.shape[<span class="dv">0</span>], low<span class="op">=</span><span class="dv">0</span>, high<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>ew[:<span class="dv">30</span>] <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> symmetric(<span class="dv">150</span>, ew <span class="op">=</span> ew, pd <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> matrix_function(A, fun<span class="op">=</span>np.sign)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Rank:       </span><span class="sc">{</span>np<span class="sc">.</span>linalg<span class="sc">.</span>matrix_rank(A)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"GR approx:  </span><span class="sc">{</span>hutch(M)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"XTrace:     </span><span class="sc">{</span>xtrace(M)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rank:       120
GR approx:  91.1152905723871
XTrace:     110.73490447673369</code></pre>
</div>
</div>
<p>This is not so much a fault of <code>hutch</code> or <code>xtrace</code> as much as it is the choice of approximation and Lanczos parameters. The <code>sign</code> function has a discontinuity at 0, is not smooth, and is difficult to approximate with low-degree polynomials.</p>
<p>One workaround to handle this issue is relax the sign function with a “soft-sign” function: <span class="math display"> \mathcal{S}_\lambda(x) = \sum\limits_{i=0}^q \left( x(1 - x^2)^i \prod_{j=1}^i \frac{2j - 1}{2j} \right)</span></p>
<p>Visually, the soft-sign function looks like this:</p>
<div id="a5867860" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> primate.special <span class="im">import</span> figure_fun</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>show(figure_fun(<span class="st">"softsign"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

  <div id="da8bdfb0-1e89-4e8c-907b-dd4ff72f89cf" data-root-id="p1001" style="display: contents;"></div>
</div>
<div class="cell-output cell-output-display">
<script type="application/javascript">
(function(root) {
  function embed_document(root) {
  const docs_json = {"762a0575-1fab-41e4-9656-be6e4a4c91c5":{"version":"3.2.2","title":"Bokeh Application","roots":[{"type":"object","name":"Figure","id":"p1001","attributes":{"width":250,"height":250,"x_range":{"type":"object","name":"DataRange1d","id":"p1002"},"y_range":{"type":"object","name":"DataRange1d","id":"p1003"},"x_scale":{"type":"object","name":"LinearScale","id":"p1011"},"y_scale":{"type":"object","name":"LinearScale","id":"p1012"},"title":{"type":"object","name":"Title","id":"p1004","attributes":{"text":"fun = softsign"}},"renderers":[{"type":"object","name":"GlyphRenderer","id":"p1036","attributes":{"data_source":{"type":"object","name":"ColumnDataSource","id":"p1030","attributes":{"selected":{"type":"object","name":"Selection","id":"p1031","attributes":{"indices":[],"line_indices":[]}},"selection_policy":{"type":"object","name":"UnionRenderers","id":"p1032"},"data":{"type":"map","entries":[["x",{"type":"ndarray","array":{"type":"bytes","data":"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"},"shape":[250],"dtype":"float64","order":"little"}],["y",{"type":"ndarray","array":{"type":"bytes","data":"AAAAAAAA8L8AAAAAAADwvwAAAAAAAPC//P//////77+c///////vv5f7/////++/bOD/////779FWv/////vv7pK/f///++/kHn2////77++x+L////vv6zBr////++/QeM2////77/3Ni3+///vv+kwCfz//++/hMPa9///77+zsRDw///vv9cWJeL//++/qAgqyv//77+rHy6i///vvxyjb2H//++/ghNU+/7/778G5xhe/v/vvzeCMXH9/++/v9lFE/z/77/4u8QX+v/vv86L/EP3/++/Bj+tS/P/779XvQbN7f/vv5ZPB0zm/++/mqkuLdz/7781Pnuvzv/vv+37qOW8/++/XUiqrqX/778bDVath//vvxPnRz9h/++/igPycjD/77+h5eL88v7vv0ktRCym/u+/Anya3kb+779wtNFy0f3vv+kEpLtB/e+/jWlt8ZL877+NjICjv/vvvysZFanB+u+/RazqEZL5779kgb4WKfjvv5jCtAl+9u+/IPLYRof077++NNskOvLvv7NJMuaK7++/rrHLqmzs77984HRi0ejvvxlPKcCp5O+/LthxLuXf77/78QHFcdrvv5ITvz881O+/id1d9y/N77/Ldb/bNsXvvwfsN3A5vO+/dHDkyR6y7798qzWQzKbvv7iez/8mmu+/JCnd7xCM77/VmPHZa3zvv+mojuQXa++/POtg8PNX779j8j+o3ULvv5mi+pOxK++/UuryLUsS778Rzob7hPbuv+c6P6g42O6/RoO3Iz+37r+czCrCcJPuv7gXj1+lbO6/+fsfhbRC7r/iszWRdRXuv+rCP+G/5O2/I1W1/Wqw7b8ojcjHTnjtvztNpahDPO2/IrL/wSL87L9PebIfxrfsv57yKeoIb+y/x/BUmcch7L8gcdIn4M/rv9F0EEYyeeu/McYOjZ8d679uK3ewC73qv9zXu69cV+q/ncjsBXvs6b8YJPXXUXzpv5Or8iDPBum/OdZa3OOL6L9eQKMthAvov+a4JYWnhee/nFv7wUj65r+3z41QZmnmv5floUUC0+W/4GmjdSI35b8aDf+H0JXkv/+uXAYa7+O/cymSZxBD47/p1ywWyZHiv5aBdnJd2+G/4vTgz+of4b+ofMptkl/gv1GyKNfyNN+/uwQXcJGh3b/VRVb4WQXcv57MjgKtYNq/YKpsJfKz2L9kBie2l//Wv1VshHoSRNW/I8awUt2B0790qUbbeLnRv0UG9A/W1s+/Ksy7bn0wzL/yipSABoHIvxst4fKXycS/S1Zvd18Lwb/y6P1/IY+6vyvG0+PI/rK/vBsiTVzQpr8Vzawvf26OvzvLrC9/bo4/gBsiTVzQpj/TxdPjyP6yP7ro/X8hj7o/PFZvd18LwT/+LOHyl8nEP+OKlIAGgcg/EMy7bn0wzD83BvQP1tbPP2apRtt4udE/HMawUt2B0z9HbIR6EkTVP1UGJ7aX/9Y/TqpsJfKz2D+QzI4CrWDaP9BFVvhZBdw/rwQXcJGh3T9LsijX8jTfP6N8ym2SX+A/4PTgz+of4T+PgXZyXdvhP+jXLBbJkeI/bymSZxBD4z/7rlwGGu/jPxMN/4fQleQ/22mjdSI35T+X5aFFAtPlP7PPjVBmaeY/mVv7wUj65j/iuCWFp4XnP11Aoy2EC+g/NNZa3OOL6D+Sq/IgzwbpPxQk9ddRfOk/msjsBXvs6T/b17uvXFfqP28rd7ALveo/MMYOjZ8d6z/OdBBGMnnrPx5x0ifgz+s/x/BUmcch7D+g8inqCG/sP0x5sh/Gt+w/IrL/wSL87D86TaWoQzztPySNyMdOeO0/JFW1/Wqw7T/rwj/hv+TtP+KzNZF1Fe4/9fsfhbRC7j+3F49fpWzuP57MKsJwk+4/R4O3Iz+37j/pOj+oONjuPxDOhvuE9u4/UuryLUsS7z+VovqTsSvvP2LyP6jdQu8/Petg8PNX7z/oqI7kF2vvP9aY8dlrfO8/JCnd7xCM7z+4ns//JprvP3yrNZDMpu8/dXDkyR6y7z8I7DdwObzvP8p1v9s2xe8/it1d9y/N7z+RE78/PNTvP/nxAcVx2u8/MNhxLuXf7z8YTynAqeTvP3zgdGLR6O8/r7HLqmzs7z+zSTLmiu/vP7002yQ68u8/HvLYRof07z+awrQJfvbvP2aBvhYp+O8/SKzqEZL57z8qGRWpwfrvP42MgKO/++8/jmlt8ZL87z/pBKS7Qf3vP3K00XLR/e8/A3ya3kb+7z9JLUQspv7vP6Hl4vzy/u8/iwPycjD/7z8U50c/Yf/vPxsNVq2H/+8/XEiqrqX/7z/u+6jlvP/vPzU+e6/O/+8/m6kuLdz/7z+WTwdM5v/vP1e9Bs3t/+8/Bj+tS/P/7z/Oi/xD9//vP/i7xBf6/+8/v9lFE/z/7z83gjFx/f/vPwfnGF7+/+8/gRNU+/7/7z8co29h///vP6wfLqL//+8/pwgqyv//7z/WFiXi///vP7SxEPD//+8/hcPa9///7z/oMAn8///vP/g2Lf7//+8/QuM2////7z+swa/////vP7/H4v///+8/kHn2////7z+6Sv3////vP0Za/////+8/bOD/////7z+W+//////vP5z//////+8//P//////7z8AAAAAAADwPwAAAAAAAPA/AAAAAAAA8D8="},"shape":[250],"dtype":"float64","order":"little"}]]}}},"view":{"type":"object","name":"CDSView","id":"p1037","attributes":{"filter":{"type":"object","name":"AllIndices","id":"p1038"}}},"glyph":{"type":"object","name":"Line","id":"p1033","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"#1f77b4"}},"nonselection_glyph":{"type":"object","name":"Line","id":"p1034","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"#1f77b4","line_alpha":0.1}},"muted_glyph":{"type":"object","name":"Line","id":"p1035","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"#1f77b4","line_alpha":0.2}}}}],"toolbar":{"type":"object","name":"Toolbar","id":"p1010","attributes":{"tools":[{"type":"object","name":"PanTool","id":"p1023"},{"type":"object","name":"WheelZoomTool","id":"p1024"},{"type":"object","name":"BoxZoomTool","id":"p1025","attributes":{"overlay":{"type":"object","name":"BoxAnnotation","id":"p1026","attributes":{"syncable":false,"level":"overlay","visible":false,"left_units":"canvas","right_units":"canvas","bottom_units":"canvas","top_units":"canvas","line_color":"black","line_alpha":1.0,"line_width":2,"line_dash":[4,4],"fill_color":"lightgrey","fill_alpha":0.5}}}},{"type":"object","name":"SaveTool","id":"p1027"},{"type":"object","name":"ResetTool","id":"p1028"},{"type":"object","name":"HelpTool","id":"p1029"}]}},"left":[{"type":"object","name":"LinearAxis","id":"p1018","attributes":{"ticker":{"type":"object","name":"BasicTicker","id":"p1019","attributes":{"mantissas":[1,2,5]}},"formatter":{"type":"object","name":"BasicTickFormatter","id":"p1020"},"major_label_policy":{"type":"object","name":"AllLabels","id":"p1021"}}}],"below":[{"type":"object","name":"LinearAxis","id":"p1013","attributes":{"ticker":{"type":"object","name":"BasicTicker","id":"p1014","attributes":{"mantissas":[1,2,5]}},"formatter":{"type":"object","name":"BasicTickFormatter","id":"p1015"},"major_label_policy":{"type":"object","name":"AllLabels","id":"p1016"}}}],"center":[{"type":"object","name":"Grid","id":"p1017","attributes":{"axis":{"id":"p1013"}}},{"type":"object","name":"Grid","id":"p1022","attributes":{"dimension":1,"axis":{"id":"p1018"}}}]}}]}};
  const render_items = [{"docid":"762a0575-1fab-41e4-9656-be6e4a4c91c5","roots":{"p1001":"da8bdfb0-1e89-4e8c-907b-dd4ff72f89cf"},"root_ids":["p1001"]}];
  root.Bokeh.embed.embed_items_notebook(docs_json, render_items);
  }
  if (root.Bokeh !== undefined) {
    embed_document(root);
  } else {
    let attempts = 0;
    const timer = setInterval(function(root) {
      if (root.Bokeh !== undefined) {
        clearInterval(timer);
        embed_document(root);
      } else {
        attempts++;
        if (attempts > 100) {
          clearInterval(timer);
          console.log("Bokeh: ERROR: Unable to run BokehJS code because BokehJS library is missing");
        }
      }
    }, 10, root)
  }
})(window);
</script>
</div>
</div>
<p>It’s been shown that there is a low degree polynomial <span class="math inline">p^\ast</span> that uniformly approximates <span class="math inline">\mathcal{S}_\lambda</span> up to a small error on the interval <span class="math inline">[-1,1]</span>. Since <code>matrix_function</code> uses a low degree Krylov subspace to approximate the action <span class="math inline">v \mapsto f(A)v</span>, replacing <span class="math inline">\mathrm{sign} \mapsto \mathcal{S}_{\lambda}</span> for some choice of <span class="math inline">q \in \mathbb{Z}_+</span> (this function is available in <code>primate</code> under the name <code>soft_sign</code>):</p>
<div id="68796883" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> primate.special <span class="im">import</span> softsign</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> q <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="dv">50</span>, <span class="dv">5</span>):</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  M <span class="op">=</span> matrix_function(A, fun<span class="op">=</span>softsign(q<span class="op">=</span>q))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="ss">f"XTrace S(A) for q=</span><span class="sc">{</span>q<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>xtrace(M)<span class="sc">:6f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>XTrace S(A) for q=0: 75.651032
XTrace S(A) for q=5: 111.879280
XTrace S(A) for q=10: 116.742739
XTrace S(A) for q=15: 118.398270
XTrace S(A) for q=20: 119.128208
XTrace S(A) for q=25: 119.495580
XTrace S(A) for q=30: 119.695982
XTrace S(A) for q=35: 119.811315
XTrace S(A) for q=40: 119.880260
XTrace S(A) for q=45: 119.922665</code></pre>
</div>
</div>
<p>As you can see, <code>XTrace</code>’s results gradually improves towards the true rank. Thus, as a rule, relaxing discontinuous spectral functions with low-degree approximations can improve the quality of the estimation.</p>
</section>
<section id="computing-the-numerical-rank" class="level2">
<h2 class="anchored" data-anchor-id="computing-the-numerical-rank">Computing the numerical rank</h2>
<p>While we do get within rounding range using the <code>softsign</code> function above, the error of the final estimate is still relatively large. In general, rank-deficient matrices are practically non-existent: the set of full-rank matrices is <em>dense</em> in <span class="math inline">\mathbb{R}^{n \times n}</span>. Instead, most practitioners are interested in estimating the <em>numerical rank</em>, defined here as the smallest rank of the matrix which is <span class="math inline">\epsilon</span>-close to <span class="math inline">A</span>: <span class="math display">\mathrm{numrank}(A) \triangleq \mathrm{min} \{ \, \mathrm{rank}(A) : X \in \mathbb{R}^{n \times n}, \lVert X - A \rVert_2 \leq \epsilon \, \}</span></p>
<p>It can be shown that if the numerical rank of an operator <span class="math inline">A</span> is <span class="math inline">r</span>, then <span class="math inline">\lambda_{r} &gt; \epsilon \geq \lambda_{r + 1}</span>. Thus, to estimate the numerical rank, its sufficient to simply threshold the <code>sign</code> function values above some fixed value <span class="math inline">\lambda_{\text{min}}</span>: <span class="math display"> S_{\lambda_{\text{min}}}(x) =
\begin{cases}
1 &amp; \text{ if } x \geq \lambda_{\text{min}} \\
0 &amp; \text{ otherwise }
\end{cases}
</span></p>
<p>The remaining task is to choose <span class="math inline">\epsilon</span>. For a generic <span class="math inline">n \times m</span> operator <span class="math inline">A</span>, NumPy uses the following formula, which accounts for accounting for the numerical errors of the corresponding SVD computation of <code>matrix_rank</code>:</p>
<p><span class="math display"> \sigma_{\text{max}} * max(M, N) * \mathrm{eps} </span></p>
<p>where <span class="math inline">\mathrm{eps}</span> is the machine epsilon and <span class="math inline">\sigma_{\text{max}}</span> is the largest singular value of <span class="math inline">A</span>. Sure enough, this actually works well computationally:</p>
<div id="b716dc08" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>ew <span class="op">=</span> np.linalg.eigvalsh(A)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>tol <span class="op">=</span> np.<span class="bu">max</span>(ew) <span class="op">*</span> A.shape[<span class="dv">0</span>] <span class="op">*</span> np.finfo(A.dtype).eps</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> matrix_function(A, fun<span class="op">=</span><span class="kw">lambda</span> x: <span class="fl">1.0</span> <span class="cf">if</span> x <span class="op">&gt;</span> tol <span class="cf">else</span> <span class="fl">0.0</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"XTrace numrank(A): </span><span class="sc">{</span>xtrace(M)<span class="sc">:6f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>XTrace numrank(A): 120.000010</code></pre>
</div>
</div>
<p>However, notice we are still using a discontinuous function—essentially the sign function offset from the origin. In fact, the notion of numerical rank is only useful if there well-defined gap between <span class="math inline">\lambda_r</span> and <span class="math inline">\lambda_{r + 1}</span>—in practice, we don’t know this value, and it is overly expensive to compute all of the eigenvalues to use the approach above.</p>
<p>One solution, which starts by viewing the translated <code>sign</code> function above as <em>step</em> function, is to relax the thresholding operation with a <em>smooth step</em> function.</p>
<div id="c18b79d1" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>show(figure_fun(<span class="st">"smoothstep"</span>, bounds <span class="op">=</span> (<span class="op">-</span><span class="fl">0.05</span>, <span class="fl">1.05</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

  <div id="e8ab0a34-e39c-4860-91f5-3d78cc0a3041" data-root-id="p1041" style="display: contents;"></div>
</div>
<div class="cell-output cell-output-display">
<script type="application/javascript">
(function(root) {
  function embed_document(root) {
  const docs_json = {"ea712242-e9c1-438b-948b-fb8d40743de6":{"version":"3.2.2","title":"Bokeh Application","roots":[{"type":"object","name":"Figure","id":"p1041","attributes":{"width":250,"height":250,"x_range":{"type":"object","name":"DataRange1d","id":"p1042"},"y_range":{"type":"object","name":"DataRange1d","id":"p1043"},"x_scale":{"type":"object","name":"LinearScale","id":"p1051"},"y_scale":{"type":"object","name":"LinearScale","id":"p1052"},"title":{"type":"object","name":"Title","id":"p1044","attributes":{"text":"fun = smoothstep"}},"renderers":[{"type":"object","name":"GlyphRenderer","id":"p1076","attributes":{"data_source":{"type":"object","name":"ColumnDataSource","id":"p1070","attributes":{"selected":{"type":"object","name":"Selection","id":"p1071","attributes":{"indices":[],"line_indices":[]}},"selection_policy":{"type":"object","name":"UnionRenderers","id":"p1072"},"data":{"type":"map","entries":[["x",{"type":"ndarray","array":{"type":"bytes","data":"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"},"shape":[250],"dtype":"float64","order":"little"}],["y",{"type":"ndarray","array":{"type":"bytes","data":"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"},"shape":[250],"dtype":"float64","order":"little"}]]}}},"view":{"type":"object","name":"CDSView","id":"p1077","attributes":{"filter":{"type":"object","name":"AllIndices","id":"p1078"}}},"glyph":{"type":"object","name":"Line","id":"p1073","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"#1f77b4"}},"nonselection_glyph":{"type":"object","name":"Line","id":"p1074","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"#1f77b4","line_alpha":0.1}},"muted_glyph":{"type":"object","name":"Line","id":"p1075","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"#1f77b4","line_alpha":0.2}}}}],"toolbar":{"type":"object","name":"Toolbar","id":"p1050","attributes":{"tools":[{"type":"object","name":"PanTool","id":"p1063"},{"type":"object","name":"WheelZoomTool","id":"p1064"},{"type":"object","name":"BoxZoomTool","id":"p1065","attributes":{"overlay":{"type":"object","name":"BoxAnnotation","id":"p1066","attributes":{"syncable":false,"level":"overlay","visible":false,"left_units":"canvas","right_units":"canvas","bottom_units":"canvas","top_units":"canvas","line_color":"black","line_alpha":1.0,"line_width":2,"line_dash":[4,4],"fill_color":"lightgrey","fill_alpha":0.5}}}},{"type":"object","name":"SaveTool","id":"p1067"},{"type":"object","name":"ResetTool","id":"p1068"},{"type":"object","name":"HelpTool","id":"p1069"}]}},"left":[{"type":"object","name":"LinearAxis","id":"p1058","attributes":{"ticker":{"type":"object","name":"BasicTicker","id":"p1059","attributes":{"mantissas":[1,2,5]}},"formatter":{"type":"object","name":"BasicTickFormatter","id":"p1060"},"major_label_policy":{"type":"object","name":"AllLabels","id":"p1061"}}}],"below":[{"type":"object","name":"LinearAxis","id":"p1053","attributes":{"ticker":{"type":"object","name":"BasicTicker","id":"p1054","attributes":{"mantissas":[1,2,5]}},"formatter":{"type":"object","name":"BasicTickFormatter","id":"p1055"},"major_label_policy":{"type":"object","name":"AllLabels","id":"p1056"}}}],"center":[{"type":"object","name":"Grid","id":"p1057","attributes":{"axis":{"id":"p1053"}}},{"type":"object","name":"Grid","id":"p1062","attributes":{"dimension":1,"axis":{"id":"p1058"}}}]}}]}};
  const render_items = [{"docid":"ea712242-e9c1-438b-948b-fb8d40743de6","roots":{"p1041":"e8ab0a34-e39c-4860-91f5-3d78cc0a3041"},"root_ids":["p1041"]}];
  root.Bokeh.embed.embed_items_notebook(docs_json, render_items);
  }
  if (root.Bokeh !== undefined) {
    embed_document(root);
  } else {
    let attempts = 0;
    const timer = setInterval(function(root) {
      if (root.Bokeh !== undefined) {
        clearInterval(timer);
        embed_document(root);
      } else {
        attempts++;
        if (attempts > 100) {
          clearInterval(timer);
          console.log("Bokeh: ERROR: Unable to run BokehJS code because BokehJS library is missing");
        }
      }
    }, 10, root)
  }
})(window);
</script>
</div>
</div>
<p>This is similar to the <code>softsign</code> function in that it can be easily approximated by a lower-degree polynomial, but it is easier to compute and parameterize.</p>
<p>In theory, replacing the thresholding function should reduce the error of the matrix function approximation. Let’s test this: for the given operator <span class="math inline">A</span>, I’ll form the matrix function <span class="math inline">f(A) \in \mathbb{R}^{n \times n}</span> explicitly and then construct an approximation for a smoothstep function at varying smoothness levels, which is determined by the parameter <code>b</code>.</p>
<div id="77e09467" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> primate.special <span class="im">import</span> smoothstep</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>ew, ev <span class="op">=</span> np.linalg.eigh(A)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>approx_errors <span class="op">=</span> []</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> b <span class="kw">in</span> np.geomspace(tol, <span class="fl">1e-8</span>, <span class="dv">50</span>):</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  s <span class="op">=</span> smoothstep(a<span class="op">=</span><span class="dv">0</span>, b<span class="op">=</span>b)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  M <span class="op">=</span> matrix_function(A, fun <span class="op">=</span> s)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  MF <span class="op">=</span> (ev <span class="op">@</span> np.diag(s(ew)) <span class="op">@</span> ev.T)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  error <span class="op">=</span> np.zeros(<span class="dv">30</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">30</span>):</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    v <span class="op">=</span> np.random.uniform(size<span class="op">=</span>A.shape[<span class="dv">0</span>], low<span class="op">=-</span><span class="dv">1</span>, high<span class="op">=+</span><span class="dv">1</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    v_truth, v_test <span class="op">=</span> np.ravel(MF <span class="op">@</span> v), np.ravel(M <span class="op">@</span> v)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    vn, vn_approx <span class="op">=</span> np.linalg.norm(v_truth), np.linalg.norm(v_test)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    max_diff <span class="op">=</span> np.<span class="bu">max</span>(np.<span class="bu">abs</span>(v_truth <span class="op">-</span> np.ravel(v_test)))</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    error[i] <span class="op">=</span> max_diff</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  approx_errors.append(error.mean())</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> figure(width<span class="op">=</span><span class="dv">500</span>, height<span class="op">=</span><span class="dv">200</span>, x_axis_type<span class="op">=</span><span class="st">"log"</span>, title<span class="op">=</span><span class="st">"MF Approximation error"</span>)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>p.line(np.geomspace(tol, <span class="fl">1e-8</span>, <span class="dv">50</span>), approx_errors)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>p.scatter(np.geomspace(tol, <span class="fl">1e-8</span>, <span class="dv">50</span>), approx_errors)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>show(p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

  <div id="b74fd49f-bf17-49ef-8c9d-e262b78d0281" data-root-id="p1081" style="display: contents;"></div>
</div>
<div class="cell-output cell-output-display">
<script type="application/javascript">
(function(root) {
  function embed_document(root) {
  const docs_json = {"a1f16377-79aa-43e2-9b29-07eb2b24b74a":{"version":"3.2.2","title":"Bokeh Application","roots":[{"type":"object","name":"Figure","id":"p1081","attributes":{"width":500,"height":200,"x_range":{"type":"object","name":"DataRange1d","id":"p1082"},"y_range":{"type":"object","name":"DataRange1d","id":"p1083"},"x_scale":{"type":"object","name":"LogScale","id":"p1091"},"y_scale":{"type":"object","name":"LinearScale","id":"p1092"},"title":{"type":"object","name":"Title","id":"p1084","attributes":{"text":"MF Approximation error"}},"renderers":[{"type":"object","name":"GlyphRenderer","id":"p1116","attributes":{"data_source":{"type":"object","name":"ColumnDataSource","id":"p1110","attributes":{"selected":{"type":"object","name":"Selection","id":"p1111","attributes":{"indices":[],"line_indices":[]}},"selection_policy":{"type":"object","name":"UnionRenderers","id":"p1112"},"data":{"type":"map","entries":[["x",{"type":"ndarray","array":{"type":"bytes","data":"CSVzl/u/Ij2OlR5uC0EoPQ+uxpm+Xy89Z66ADMFKND0OCogLtD86PQD/uKon+kA9JIKiPP71RT0CS41YXGhMPfz9OvyZX1I9Ef+Pv17EVz03sAuZeL5ePZCFtS1y4mM9AA68Zca4aT0Krlbl4qJwPQQ0CTUbhXU9fZQN2FXWez2XRg/QJwGCPfESBfAySoc9PJrymG8gjj0U6xh9O3yTPaD7M1SONJk9/u9nt15NoD0WWad0fBalPYxM0PY9R6s9b587IJuksT17/i8he9K2PWngHfSShb09ZcqCNhIYwz1w7bHp/bLIPQvhAj4k8889tTynVBaq1D1yAV+iBbvaPfeeLi3qSeE9pNHotipd5j1P48Ba0u3sPd2sIs3rtfI9n5eOgAc0+D0FMQqR6E7/PRj9F2rdPwQ+3R29FZ4xCj6n9XJpC/EQPkd52VU16hU+tRjo0B1ZHD5+P2PqvVUiPkpLSbmdtyc+WRhoG/mtLj6Mq7mExtczPrin2df4qjk+k9itePWZQD46jDDijnlFPg=="},"shape":[50],"dtype":"float64","order":"little"}],["y",[0.0001394814129789058,7.378606564564655e-05,4.513941633214359e-05,2.828951574155638e-05,1.7310425813162503e-05,1.0808238596750458e-05,6.371224275132156e-06,3.078247406143944e-06,1.8649261823123578e-06,1.3161954716657543e-06,7.645505816394944e-07,4.45325933705563e-07,2.786495808974887e-07,2.078391117369659e-07,1.157037507896567e-07,5.3869706578256923e-08,3.2534457881797445e-08,2.124977982412623e-08,1.0268636993030859e-08,7.1286427652354765e-09,4.935540004527098e-09,2.8620901149079002e-09,2.215237655621817e-09,1.82545295222362e-09,1.7368013082045529e-09,1.486152232527127e-09,1.669991556036791e-09,1.6021620051342768e-09,1.5589029113879013e-09,1.632177668714485e-09,1.6227377918250537e-09,1.663659024489043e-09,1.5224525929154417e-09,1.5822466892245756e-09,1.5731284300386783e-09,1.6249085297200446e-09,1.512930268565693e-09,1.5965474354599311e-09,1.6123199190684612e-09,1.5225472357998279e-09,1.587211020022868e-09,1.5694897255678444e-09,1.5185637728768833e-09,1.6025234584783842e-09,1.5713417452628553e-09,1.6829877868644131e-09,1.7502913148929415e-09,1.5426945952172014e-09,1.6783001946807838e-09,1.538379235457854e-09]]]}}},"view":{"type":"object","name":"CDSView","id":"p1117","attributes":{"filter":{"type":"object","name":"AllIndices","id":"p1118"}}},"glyph":{"type":"object","name":"Line","id":"p1113","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"#1f77b4"}},"nonselection_glyph":{"type":"object","name":"Line","id":"p1114","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"#1f77b4","line_alpha":0.1}},"muted_glyph":{"type":"object","name":"Line","id":"p1115","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":"#1f77b4","line_alpha":0.2}}}},{"type":"object","name":"GlyphRenderer","id":"p1125","attributes":{"data_source":{"type":"object","name":"ColumnDataSource","id":"p1119","attributes":{"selected":{"type":"object","name":"Selection","id":"p1120","attributes":{"indices":[],"line_indices":[]}},"selection_policy":{"type":"object","name":"UnionRenderers","id":"p1121"},"data":{"type":"map","entries":[["x",{"type":"ndarray","array":{"type":"bytes","data":"CSVzl/u/Ij2OlR5uC0EoPQ+uxpm+Xy89Z66ADMFKND0OCogLtD86PQD/uKon+kA9JIKiPP71RT0CS41YXGhMPfz9OvyZX1I9Ef+Pv17EVz03sAuZeL5ePZCFtS1y4mM9AA68Zca4aT0Krlbl4qJwPQQ0CTUbhXU9fZQN2FXWez2XRg/QJwGCPfESBfAySoc9PJrymG8gjj0U6xh9O3yTPaD7M1SONJk9/u9nt15NoD0WWad0fBalPYxM0PY9R6s9b587IJuksT17/i8he9K2PWngHfSShb09ZcqCNhIYwz1w7bHp/bLIPQvhAj4k8889tTynVBaq1D1yAV+iBbvaPfeeLi3qSeE9pNHotipd5j1P48Ba0u3sPd2sIs3rtfI9n5eOgAc0+D0FMQqR6E7/PRj9F2rdPwQ+3R29FZ4xCj6n9XJpC/EQPkd52VU16hU+tRjo0B1ZHD5+P2PqvVUiPkpLSbmdtyc+WRhoG/mtLj6Mq7mExtczPrin2df4qjk+k9itePWZQD46jDDijnlFPg=="},"shape":[50],"dtype":"float64","order":"little"}],["y",[0.0001394814129789058,7.378606564564655e-05,4.513941633214359e-05,2.828951574155638e-05,1.7310425813162503e-05,1.0808238596750458e-05,6.371224275132156e-06,3.078247406143944e-06,1.8649261823123578e-06,1.3161954716657543e-06,7.645505816394944e-07,4.45325933705563e-07,2.786495808974887e-07,2.078391117369659e-07,1.157037507896567e-07,5.3869706578256923e-08,3.2534457881797445e-08,2.124977982412623e-08,1.0268636993030859e-08,7.1286427652354765e-09,4.935540004527098e-09,2.8620901149079002e-09,2.215237655621817e-09,1.82545295222362e-09,1.7368013082045529e-09,1.486152232527127e-09,1.669991556036791e-09,1.6021620051342768e-09,1.5589029113879013e-09,1.632177668714485e-09,1.6227377918250537e-09,1.663659024489043e-09,1.5224525929154417e-09,1.5822466892245756e-09,1.5731284300386783e-09,1.6249085297200446e-09,1.512930268565693e-09,1.5965474354599311e-09,1.6123199190684612e-09,1.5225472357998279e-09,1.587211020022868e-09,1.5694897255678444e-09,1.5185637728768833e-09,1.6025234584783842e-09,1.5713417452628553e-09,1.6829877868644131e-09,1.7502913148929415e-09,1.5426945952172014e-09,1.6783001946807838e-09,1.538379235457854e-09]]]}}},"view":{"type":"object","name":"CDSView","id":"p1126","attributes":{"filter":{"type":"object","name":"AllIndices","id":"p1127"}}},"glyph":{"type":"object","name":"Scatter","id":"p1122","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":{"type":"value","value":"#1f77b4"},"fill_color":{"type":"value","value":"#1f77b4"}}},"nonselection_glyph":{"type":"object","name":"Scatter","id":"p1123","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":{"type":"value","value":"#1f77b4"},"line_alpha":{"type":"value","value":0.1},"fill_color":{"type":"value","value":"#1f77b4"},"fill_alpha":{"type":"value","value":0.1},"hatch_alpha":{"type":"value","value":0.1}}},"muted_glyph":{"type":"object","name":"Scatter","id":"p1124","attributes":{"x":{"type":"field","field":"x"},"y":{"type":"field","field":"y"},"line_color":{"type":"value","value":"#1f77b4"},"line_alpha":{"type":"value","value":0.2},"fill_color":{"type":"value","value":"#1f77b4"},"fill_alpha":{"type":"value","value":0.2},"hatch_alpha":{"type":"value","value":0.2}}}}}],"toolbar":{"type":"object","name":"Toolbar","id":"p1090","attributes":{"tools":[{"type":"object","name":"PanTool","id":"p1103"},{"type":"object","name":"WheelZoomTool","id":"p1104"},{"type":"object","name":"BoxZoomTool","id":"p1105","attributes":{"overlay":{"type":"object","name":"BoxAnnotation","id":"p1106","attributes":{"syncable":false,"level":"overlay","visible":false,"left_units":"canvas","right_units":"canvas","bottom_units":"canvas","top_units":"canvas","line_color":"black","line_alpha":1.0,"line_width":2,"line_dash":[4,4],"fill_color":"lightgrey","fill_alpha":0.5}}}},{"type":"object","name":"SaveTool","id":"p1107"},{"type":"object","name":"ResetTool","id":"p1108"},{"type":"object","name":"HelpTool","id":"p1109"}]}},"left":[{"type":"object","name":"LinearAxis","id":"p1098","attributes":{"ticker":{"type":"object","name":"BasicTicker","id":"p1099","attributes":{"mantissas":[1,2,5]}},"formatter":{"type":"object","name":"BasicTickFormatter","id":"p1100"},"major_label_policy":{"type":"object","name":"AllLabels","id":"p1101"}}}],"below":[{"type":"object","name":"LogAxis","id":"p1093","attributes":{"ticker":{"type":"object","name":"LogTicker","id":"p1094","attributes":{"num_minor_ticks":10,"mantissas":[1,5]}},"formatter":{"type":"object","name":"LogTickFormatter","id":"p1095"},"major_label_policy":{"type":"object","name":"AllLabels","id":"p1096"}}}],"center":[{"type":"object","name":"Grid","id":"p1097","attributes":{"axis":{"id":"p1093"}}},{"type":"object","name":"Grid","id":"p1102","attributes":{"dimension":1,"axis":{"id":"p1098"}}}]}}]}};
  const render_items = [{"docid":"a1f16377-79aa-43e2-9b29-07eb2b24b74a","roots":{"p1081":"b74fd49f-bf17-49ef-8c9d-e262b78d0281"},"root_ids":["p1081"]}];
  root.Bokeh.embed.embed_items_notebook(docs_json, render_items);
  }
  if (root.Bokeh !== undefined) {
    embed_document(root);
  } else {
    let attempts = 0;
    const timer = setInterval(function(root) {
      if (root.Bokeh !== undefined) {
        clearInterval(timer);
        embed_document(root);
      } else {
        attempts++;
        if (attempts > 100) {
          clearInterval(timer);
          console.log("Bokeh: ERROR: Unable to run BokehJS code because BokehJS library is missing");
        }
      }
    }, 10, root)
  }
})(window);
</script>
</div>
</div>
<p>Sure enough, the error of the approximation decreases monotonically as we relax the step function further and further. On the other hand, we don’t want to relax too much, as this will yield a biased estimator of the rank: the largest value of <span class="math inline">\epsilon</span> we can safely choose is the given by the smallest positive eigenvalue of <span class="math inline">A</span>, as all eigenvalues equal to or larger than this are mapped to <span class="math inline">1</span>. Accounting for round-off error, if we choose <span class="math inline">\epsilon</span> to be slightly lower than this, we should in theory be able to recover the numerical rank to a higher accuracy than before:</p>
<div id="fdc56cee" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>tol <span class="op">=</span> <span class="bu">max</span>(ew) <span class="op">*</span> A.shape[<span class="dv">0</span>] <span class="op">*</span> np.finfo(A.dtype).eps</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>lambda_min <span class="op">=</span> <span class="bu">min</span>(ew[ew <span class="op">&gt;</span> tol])</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>lambda_max <span class="op">=</span> <span class="bu">max</span>(ew)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Smallest / largest non-zero eigenvalue: </span><span class="sc">{</span>lambda_min<span class="sc">:.6f}</span><span class="ss"> / </span><span class="sc">{</span>lambda_max<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>ss <span class="op">=</span> smoothstep(a <span class="op">=</span> tol, b <span class="op">=</span> <span class="fl">0.90</span><span class="op">*</span>lambda_min)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> matrix_function(A, fun<span class="op">=</span>ss)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"XTrace S_t(A) for t=</span><span class="sc">{</span>lambda_min<span class="op">*</span><span class="fl">0.90</span><span class="sc">:.4f}</span><span class="ss">: </span><span class="sc">{</span>xtrace(M)<span class="sc">:8f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Smallest / largest non-zero eigenvalue: 0.237307 / 0.999996
XTrace S_t(A) for t=0.2136: 120.000000</code></pre>
</div>
</div>
<p>Indeed, this works! Of course, here we’ve used the fact that we know the optimal cutoff values <span class="math inline">\lambda_{\mathrm{min}}</span> and <span class="math inline">\lambda_{\mathrm{min}}</span>. Then again, these can also be quickly estimated with the <code>lanczos</code> method itself.</p>
<div id="a608af1b" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> primate.diagonalize <span class="im">import</span> lanczos</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.linalg <span class="im">import</span> eigvalsh_tridiagonal</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>a,b <span class="op">=</span> lanczos(A)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>rr <span class="op">=</span> eigvalsh_tridiagonal(a,b) <span class="co"># Rayleigh-Ritz values</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Max eigenvalue: </span><span class="sc">{</span>lambda_max<span class="sc">:.6f}</span><span class="ss">, max Ritz value: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">max</span>(rr)<span class="sc">:.6f}</span><span class="ss">, Error: </span><span class="sc">{</span><span class="bu">abs</span>(np.<span class="bu">max</span>(rr) <span class="op">-</span> lambda_max)<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Min eigenvalue: </span><span class="sc">{</span>lambda_min<span class="sc">:.6f}</span><span class="ss">, min Ritz value: </span><span class="sc">{</span><span class="bu">min</span>(rr[rr <span class="op">&gt;</span> tol])<span class="sc">:.6f}</span><span class="ss">, Error: </span><span class="sc">{</span><span class="bu">abs</span>(<span class="bu">min</span>(rr[rr <span class="op">&gt;</span> tol]) <span class="op">-</span> lambda_min)<span class="sc">:.6f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Max eigenvalue: 0.999996, max Ritz value: 0.999996, Error: 0.000000
Min eigenvalue: 0.237307, min Ritz value: 0.237307, Error: 0.000000</code></pre>
</div>
</div>
</section>
<section id="packaging-it-all-up" class="level2">
<h2 class="anchored" data-anchor-id="packaging-it-all-up">Packaging it all up</h2>
<div id="437b424d" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> primate.functional <span class="im">import</span> numrank</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>numrank(A, est<span class="op">=</span><span class="st">"hutch"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>120</code></pre>
</div>
</div>
<p><code>numrank</code> Rather than designing your own does. <code>primate</code> contains a variety of</p>
</section>
<section id="polynomial-trace-approximation" class="level2">
<h2 class="anchored" data-anchor-id="polynomial-trace-approximation">Polynomial trace approximation</h2>
<div id="0933855b" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># B = A / np.max(np.linalg.eigvalsh(A))</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># (3 * (B @ B) - 2 * (B @ B @ B)).trace()</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># (6 * np.linalg.matrix_power(A, 5) - 15 * np.linalg.matrix_power(A, 4) + 10 * np.linalg.matrix_power(A, 3)).trace()</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># coeffs = [924, -6006, 16380, -24024, 20020, -9009, 1716]</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># powers = [13, 12, 11, 10, 9, 8, 7]</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co"># sum([(c*np.linalg.matrix_power(A, p)).trace() for c,p in zip(coeffs, powers)])</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co"># B = </span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ss = l</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- ```{python}
ew, ev = np.linalg.eigh(A)
approx_errors = []
pts = np.geomspace(0.10*np.min(ew[ ew > tol]), np.max(ew) / 2, 50)
for b in pts:
  s = smoothstep(a=0, b=b)
  M = matrix_function(A, fun = s)
  MF = (ev @ np.diag(s(ew)) @ ev.T)
  error = np.zeros(30)
  for i in range(30):
    v = np.random.uniform(size=A.shape[0], low=-1, high=+1)
    v_truth, v_test = np.ravel(MF @ v), np.ravel(M @ v)
    vn, vn_approx = np.linalg.norm(v_truth), np.linalg.norm(v_test)
    max_diff = np.max(np.abs(v_truth - np.ravel(v_test)))
    error[i] = max_diff
  approx_errors.append(error.mean())

p = figure(width=500, height=200, x_axis_type="log", title="MF Approximation error")
p.line(pts, approx_errors)
p.scatter(pts, approx_errors)
show(p)
``` -->
<!-- If the type of operator `A` is known to typically have a large [spectral gap](https://en.wikipedia.org/wiki/Spectral_gap), the interval range in which we can choose $\epsilon$ and expect to recover the rank is . -->
<p><!-- Since the trace estimators all stochastic to some degree, we set the cutoff to slightly less than this value:  --> <!-- # from primate.special import smoothstep
# from primate.operator import matrix_function
# v = np.random.uniform(size=A.shape[0], low=-1, high=+1)
# ew, ev = np.linalg.eigh(A)
  # print(f"f(A)v norm:  {vn:.6f}")
  # print(f"Approx norm: {vn_approx:.6f}")
  # print(f"Max diff:    {np.max(np.abs(v_truth - np.ravel(v_test))):.6e}")
  # print(f"cosine sim:  {np.dot(v_test, v_truth) / (vn * vn_approx):6e}") --></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    const typesetMath = (el) => {
      if (window.MathJax) {
        // MathJax Typeset
        window.MathJax.typeset([el]);
      } else if (window.katex) {
        // KaTeX Render
        var mathElements = el.getElementsByClassName("math");
        var macros = [];
        for (var i = 0; i < mathElements.length; i++) {
          var texText = mathElements[i].firstChild;
          if (mathElements[i].tagName == "SPAN") {
            window.katex.render(texText.data, mathElements[i], {
              displayMode: mathElements[i].classList.contains('display'),
              throwOnError: false,
              macros: macros,
              fleqn: false
            });
          }
        }
      }
    }
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        typesetMath(container);
        return container.innerHTML
      } else {
        typesetMath(note);
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      typesetMath(note);
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright 2023, Matt Piekenbrock</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js" type="text/javascript"></script>
<script type="text/javascript">
(function(d) {
  d.querySelectorAll(".pseudocode-container").forEach(function(el) {
    let pseudocodeOptions = {
      indentSize: el.dataset.indentSize || "1.2em",
      commentDelimiter: el.dataset.commentDelimiter || "//",
      lineNumber: el.dataset.lineNumber === "true" ? true : false,
      lineNumberPunc: el.dataset.lineNumberPunc || ":",
      noEnd: el.dataset.noEnd === "true" ? true : false,
      titlePrefix: el.dataset.algTitle || "Algorithm"
    };
    pseudocode.renderElement(el.querySelector(".pseudocode"), pseudocodeOptions);
  });
})(document);
(function(d) {
  d.querySelectorAll(".pseudocode-container").forEach(function(el) {
    titleSpan = el.querySelector(".ps-root > .ps-algorithm > .ps-line > .ps-keyword")
    titlePrefix = el.dataset.algTitle;
    titleIndex = el.dataset.chapterLevel ? el.dataset.chapterLevel + "." + el.dataset.pseudocodeIndex : el.dataset.pseudocodeIndex;
    titleSpan.innerHTML = titlePrefix + " " + titleIndex + " ";
  });
})(document);
</script>




</body></html>